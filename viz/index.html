<!DOCTYPE html>
<html>
    <head>
        <title>fuzzyset.js debugger</title>
        <style type="text/css">
            html, body {
                margin: 10px;
                padding: 0;
                font-size: 13px;
                font-family: Helvetica, Arial, sans-serif;
                line-height: 1;
            }
            table {
                border-collapse: collapse;
                border-spacing: none;
            }
            p {
                margin: 0 0 10px 0;
            }
            td, th {
                vertical-align: top;
                font-family: "Lucida Console", monospace;
                padding: 2px;
            }
            #items th {
                /*font-weight: normal;*/
                text-align: left;

                padding: 20px 0 10px 0;
            }

            section {
                clear: both;
            }

            #state {
                margin-top: 100px;
            }

            div {
                display: inline-block;
                float: left;
                margin: 10px 30px 10px 0;
            }

            tr.highlighted td, #lookupGrams2 td, #lookupGrams3 td {
                font-weight: bold;
                padding-right: 10px;
                background-color: yellow;
                border-bottom: 3px solid white;
            }

            tr.highlighted td:first-child:before, #lookupGrams tr td:first-child:before {
                font-weight: bold;
                background-color: yellow;
            }

            h2 {
                font-size: 22px;
                border-bottom: 3px solid black;
                padding-bottom: 3px;
            }
            h3 {
                border-bottom: 1px solid black;
                padding-bottom: 4px;
                margin-top: 0;
            }

            .mouseover:hover, #items .mouseover {
                cursor: default;
                background-color: black;
                color: white;
            }

            .fuzzyset-items-highlightedgram {
                color: white;
                background-color: black;
            }

            .sqrt {
                width: 220px;
                line-height: 1.5;
                display: inline-block;
                margin-top: 5px;
                padding-top: 5px;
                border-top: 1px solid #ccc;
            }

            .notReturned {
                color: #999;
                text-decoration: line-through;
            }

        </style>
        <!-- <link href="" rel="stylesheet"> -->
    </head>
    <body>
        <h1><a href="http://glench.github.io/fuzzyset.js/">Fuzzyset.js</a> debugger</h1>
        <p>An interface for helping understand what the fuzzyset.js code library is doing internally.</p>

        <p><b>TODO:</b> should figure out how to show cosine similarity process before tuesday meeting, make grams counter work</p>

        <div id="container"></div>

        <script src="underscore-min.js"></script>
        <!-- <script src="http://epeli.github.io/underscore.string/lib/underscore.string.js"></script> -->
        <script src="jquery-1.11.0.min.js"></script>
        <script src="d3.v3.min.js" charset="utf-8"></script>
        <script src="react-with-addons.js" charset="utf-8"></script>
        <script src="react-dom.js" charset="utf-8"></script>

        <script src="../lib/fuzzyset.js" charset="utf-8"></script>

        <script type="text/javascript">
        states = [
                    "Alabama",
                    "Alaska",
                    "American Samoa",
                    "Arizona",
                    "Arkansas",
                    "California",
                    "Colorado",
                    "Connecticut",
                    "Delaware",
                    "District of Columbia",
                    "Florida",
                    "Georgia",
                    "Guam",
                    "Hawaii",
                    "Idaho",
                    "Illinois",
                    "Indiana",
                    "Iowa",
                    "Kansas",
                    "Kentucky",
                    "Louisiana",
                    "Maine",
                    "Maryland",
                    "Massachusetts",
                    "Michigan",
                    "Minnesota",
                    "Mississippi",
                    "Missouri",
                    "Montana",
                    "Nebraska",
                    "Nevada",
                    "New Hampshire",
                    "New Jersey",
                    "New Mexico",
                    "New York",
                    "North Carolina",
                    "North Dakota",
                    "Northern Marianas Islands",
                    "Ohio",
                    "Oklahoma",
                    "Oregon",
                    "Pennsylvania",
                    "Puerto Rico",
                    "Rhode Island",
                    "South Carolina",
                    "South Dakota",
                    "Tennessee",
                    "Texas",
                    "Utah",
                    "Vermont",
                    "Virginia",
                    "Virgin Islands",
                    "Washington",
                    "West Virginia",
                    "Wisconsin",
                    "Wyoming"
                ];
        </script>
        <script type="text/javascript">
            $(document).on("ready", function(evt) {
                fuzzyset = FuzzySet([
                    'Glen Chiacchieri'
                ]);


                var _nonWordRe = /[^a-zA-Z0-9\u00C0-\u00FF, ]+/;

                var _iterateGrams = function(value, gramSize) {
                    gramSize = gramSize || 2;
                    var simplified = '-' + value.toLowerCase().replace(_nonWordRe, '') + '-',
                        lenDiff = gramSize - simplified.length,
                        results = [];
                    if (lenDiff > 0) {
                        for (var i = 0; i < lenDiff; ++i) {
                            value += '-';
                        }
                    }
                    for (var i = 0; i < simplified.length - gramSize + 1; ++i) {
                        results.push(simplified.slice(i, i + gramSize));
                    }
                    return results;
                };

                var _gramCounter = function(value, gramSize) {
                    // return an object where key=gram, value=number of occurrences
                    gramSize = gramSize || 2;
                    var result = {};
                    var grams = _iterateGrams(value, gramSize);
                    var i = 0;
                    for (i; i < grams.length; ++i) {
                        if (grams[i] in result) {
                            result[grams[i]] += 1;
                        } else {
                            result[grams[i]] = 1;
                        }
                    }
                    return result;
                };

                Table = React.createClass({
                    render: function() {
                        if (_.isString(this.props.obj) || _.isNumber(this.props.obj)) {
                            return React.createElement('span', null, this.props.obj)
                        } else if (_.isArray(this.props.obj) && this.props.obj.length ==2 && !_.isArray(this.props.obj[0])) {
                            return React.createElement('span', null, '('+this.props.obj[0]+', '+this.props.obj[1]+')')
                        } else if (_.isNull(this.props.obj)) {
                            return React.createElement('span', null, 'nothing');
                        }
                        var table_cells = _.map(this.props.obj, (value, key) => {
                            var key_cell = _.isNumber(key) ? null : React.createElement('td', null, key);
                            return React.createElement('tr', null, [
                                key_cell,
                                React.createElement('td', null, React.createElement(Table, {obj: value}))
                            ])
                        });
                        return React.createElement('table', null, 
                            React.createElement('tbody', null,
                                table_cells
                            )
                        )
                    }
                });

                App = React.createClass({
                    getInitialState: function() {
                        return {
                            entryText: '',
                            lookupText: 'glen c',
                            highlightedItemIndex: -1,
                            highlightedGramSize: '0',
                            highlightedGram: null,
                        }
                    },

                    entryTextChange: function(evt) {
                        this.setState({entryText: evt.target.value})
                    },

                    addEntry: function(evt) {
                        evt.preventDefault();
                        fuzzyset.add(this.state.entryText)
                        this.setState({entryText: ''})
                    },

                    lookupTextChange: function(evt) {
                        this.setState({lookupText: evt.target.value})
                    },

                    clear_set: function() {
                        fuzzyset = FuzzySet();
                        this.setState({lookupText: ''});
                        $('form input').focus();
                    },

                    load_states: function() {
                        fuzzyset = FuzzySet(states)
                        this.setState({lookupText: ''})
                    },

                    toggle_levenshtein: function() {
                        fuzzyset.useLevenshtein = !fuzzyset.useLevenshtein;
                        this.forceUpdate() // just tell react to update results
                    },

                    highlightItem: function(evt) {
                        this.setState({
                            highlightedGramSize: evt.target.getAttribute('data-gram-size'),
                            highlightedItemIndex: parseInt(evt.target.getAttribute('data-item-index'), 10),
                        });
                    },

                    dehighlightItem: function() {
                        this.setState({
                            highlightedGramSize: '0',
                            highlightedItemIndex: -1,
                        });
                    },

                    highlightGram: function(evt) {
                        this.setState({
                            highlightedGram: evt.target.getAttribute('data-gram'),
                            highlightedItemIndex: parseInt(evt.target.getAttribute('data-item-index'), 10),
                        })
                    },

                    dehighlightGram: function(evt) {
                        this.setState({
                            highlightedGram: null,
                            highlightedItemIndex: -1,
                        })
                    },

                    render: function() {
                        var lookupGrams3 = _gramCounter(this.state.lookupText, 3);
                        var lookupGrams2 = _gramCounter(this.state.lookupText, 2);

                        fuzzyset.get(this.state.lookupText)


                        return React.createElement('div', {id: 'app'},
                            [
                                React.createElement('section', {id: 'lookup'},
                                    [
                                        React.createElement('h2', null, 'Lookup'),
                                        React.createElement('div', {style: {float: 'left'}}, [
                                            React.createElement('label', null, 'Query: '),
                                            React.createElement('input', {placeholder: 'lookup entry', onChange: this.lookupTextChange, value: this.state.lookupText, style: {}, type: 'search'}),

                                            React.createElement('br'),

                                            React.createElement('input', {type: 'checkbox', checked: fuzzyset.useLevenshtein, onChange: this.toggle_levenshtein, id: 'useLevenshtein', style: {marginTop: 10}}),
                                            React.createElement('label', {htmlFor: 'useLevenshtein'}, 'useLevenshtein'),
                                        ]),
                                        React.createElement('div', {id: 'lookupResults'}, [
                                                React.createElement('h3', null, 'fuzzyset.get(\''+ this.state.lookupText +'\', minScore=.33)'),
                                                // React.createElement(Table, {obj: fuzzyset.get(this.state.lookupText)})
                                                React.createElement('div', null, _.map(fuzzyset.debug_results, result => {
                                                    return React.createElement('p', {className: result[0] > .33 ? 'returned' : 'notReturned'}, `(${result[0]}, ${result[1]})`)
                                                }))
                                                // React.createElement(Table, {obj: fuzzyset.debug_results})
                                            ]
                                        ),
                                        React.createElement('div', {id: 'lookupGrams3'}, [
                                                React.createElement('h3', null, '_gramCounter(\''+ this.state.lookupText +'\', 3)'),
                                                React.createElement(Table, {obj: lookupGrams3}),
                                                React.createElement('span', {className: "sqrt"}, 'sqrt(', _.map(lookupGrams3, value => value+'² + '), '0) = ',
                                                    Math.sqrt(_.reduce(_.map(lookupGrams3, count => Math.pow(count, 2)), (memo, num) => memo+num, 0)))
                                            ]
                                        ),
                                        React.createElement('div', {id: 'lookupGrams2'}, [
                                                React.createElement('h3', null, '_gramCounter(\''+ this.state.lookupText +'\', 2)'),
                                                React.createElement(Table, {obj: lookupGrams2}),
                                                React.createElement('span', {className: 'sqrt'}, 'sqrt(', _.map(lookupGrams2, value => value+'² + '), '0) = ',
                                                    Math.sqrt(_.reduce(_.map(lookupGrams2, count => Math.pow(count, 2)), (memo, num) => memo+num, 0)))
                                            ]
                                        ),

                                    ]
                                ),


                                React.createElement('section', {id: 'state'}, [
                                    React.createElement('h2', null, 'State'),
                                    React.createElement('div', {style: {float: 'none', display: 'block'}}, [
                                        React.createElement('form', {onSubmit: this.addEntry},
                                            [
                                                React.createElement('input', {placeholder: 'add entry', id: 'add', onChange: this.entryTextChange, value: this.state.entryText, style:{fontSize: 18}}),
                                                React.createElement('span', {style: {marginLeft: 6}}, 'type and press enter to add an entry: fuzzyset.add(\''+ this.state.entryText +'\')'),
                                            ]
                                        ),


                                        React.createElement('input', {value: fuzzyset.gramSizeUpper, readOnly: true, size: 2, style: {marginTop: 10}}),
                                        React.createElement('span', null, '-grams to '),
                                        React.createElement('input', {value: fuzzyset.gramSizeLower, readOnly: true, size: 2}),
                                        React.createElement('span', null, '-grams'),

                                        React.createElement('div', {style: {float: 'none', display: 'block'}}, [
                                            React.createElement('button', {onClick: this.load_states, style: {marginRight: 10}}, 'load US state names'),
                                            React.createElement('button', {onClick: this.clear_set, style: {}}, 'reset'),
                                        ]),
                                    ]),



                                    React.createElement('div', {id: 'matchDict'}, [
                                            React.createElement('h3', null, 'fuzzyset.matchDict'),
                                            React.createElement('p', {style: {width: 200, lineHeight: 1.3}}, 'Hover over each number to see a description of what that number means.'),
                                            React.createElement('table', null,
                                                React.createElement('tbody', null,
                                                _.map(fuzzyset.matchDict, (indexAndCounts, gram) => {
                                                    return indexAndCounts.map((indexAndCount, i) => {
                                                        var first_cell = React.createElement('td', {key: i+gram+1}, '   ');
                                                        if (i == 0) {
                                                            first_cell = React.createElement('td', {key: i+gram+1, style: {textAlign: 'right'}}, gram.replace(' ', '_'));
                                                        }
                                                        return React.createElement('tr', {className: (gram in lookupGrams3 || gram in lookupGrams2 ? 'highlighted' : ''), key: i+gram+indexAndCount},
                                                            [
                                                            first_cell,
                                                            React.createElement('td', {key: i+gram+2, style:{paddingLeft: 10}}, 
                                                                [
                                                                    React.createElement('span', null, '('),
                                                                    React.createElement('span', {onMouseEnter: this.highlightItem, onMouseLeave: this.dehighlightItem, className: 'mouseover', style: {padding: '0 2px'}, title: `The gram '${gram}' comes from item #${indexAndCount[0]} in fuzzyset.items[${gram.length}]: ${fuzzyset.items[gram.length][indexAndCount[0]]}`, key: i+'index'+indexAndCount[0], 'data-gram-size': gram.length, 'data-item-index': indexAndCount[0]}, indexAndCount[0]),
                                                                    React.createElement('span', null, ','),
                                                                    React.createElement('span', {
                                                                        className: 'mouseover',
                                                                        onMouseEnter: this.highlightGram,
                                                                        onMouseLeave: this.dehighlightGram,
                                                                        'data-gram': gram,
                                                                        'data-item-index': indexAndCount[0],
                                                                        style: {padding: '0 2px 0 4px'}, title: `The gram '${gram}' appears in '${fuzzyset.items[gram.length][indexAndCount[0]][1]}' ${indexAndCount[1]} time${indexAndCount[1] > 1 ? 's' : ''}.`, key: i+'count'+indexAndCount[1]}, indexAndCount[1]),
                                                                    React.createElement('span', null, ')'),
                                                                ]   
                                                            )
                                                            ]
                                                        )
                                                    }
                                                )
                                            })
                                            )
                                            ) 
                                        ]
                                    ),
                                    React.createElement('div', {id: 'items'}, [
                                            React.createElement('h3', null, 'fuzzyset.items'),
                                            React.createElement('table', null, React.createElement('tbody', null,
                                                _.map(fuzzyset.items, (pairs, gramSize) => {
                                                    return [
                                                        React.createElement('tr', null, [
                                                            React.createElement('th', null, gramSize+'-grams: '),
                                                            React.createElement('td', null),
                                                        ]),
                                                        _.map(pairs, (pair, i) => {
                                                            var split_pair = [];
                                                            if (this.state.highlightedGram && this.state.highlightedItemIndex === i) {
                                                                var split_regex = new RegExp(this.state.highlightedGram.replace(/^-/, '^').replace(/-$/, '$'))

                                                                if (split_regex.test(pair[1])) {
                                                                    split_pair = pair[1].split(split_regex)
                                                                    console.log('before', split_pair)
                                                                    split_pair.forEach((substring, index) => {
                                                                        if (index % 2 == 0) {
                                                                            split_pair.splice(index+1, 0, React.createElement('span', {className: 'fuzzyset-items-highlightedgram'}, this.state.highlightedGram))
                                                                        }
                                                                    })
                                                                    console.log(this.state.highlightedGram, 'after', split_pair)
                                                                }
                                                            } else {
                                                                split_pair.push(pair[1])
                                                            }
                                                            split_pair.push(')');
                                                            return React.createElement('tr', {className: this.state.highlightedItemIndex == i && this.state.highlightedGramSize == gramSize ? 'mouseover' : ''}, [
                                                                React.createElement('td', null, `#${i}`),
                                                                React.createElement('td', null, '('+pair[0]+','),
                                                                React.createElement('td', {style: {paddingLeft: 8}}, split_pair),
                                                            ]);
                                                        }),
                                                    ]
                                                })

                                            )),
                                        ]
                                    ),
                                    React.createElement('div', {id: 'exactSet'}, [
                                        React.createElement('h3', null, 'fuzzyset.exactSet'),
                                        React.createElement(Table, {obj: fuzzyset.exactSet})
                                        // _.map(fuzzyset.exactSet, entry => {
                                        //     return React.createElement('p', null, entry)
                                        // })
                                        ]
                                    ),
                                ])
                            ]
                        )
                    }
                });

                ReactDOM.render(React.createElement(App), document.querySelector('#container'))
            });
        </script>
    </body>
</html>
